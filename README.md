# yarxyarx easy x-ray instrumentation in go

yarxyarx creates a slim wrapper around the [AWS SDK for Go](https://github.com/aws/aws-sdk-go) that facilitates instrumentation with the [AWS X-Ray SDK for Go](https://github.com/aws/aws-xray-sdk-go) without needing to make extensive changes to your code.
Unlike some of the other platforms with X-Ray support, like [python](https://github.com/aws/aws-xray-sdk-python), integrating X-Ray into Go code can be a pain. A couple of lines of code are all you need to add X-Ray's monkey-patches in python. In Go, though, you need to [call specific versions of AWS SDK APIs](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-go-awssdkclients.html), [wrap your HTTP clients](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-go-httpclients.html), [change your incoming HTTP handlers](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-go-handler.html), and [use X-Ray's SQL() function instead of sql.Open()](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-go-sqlclients.html). If you didn't keep all this in mind during development, you'll be fighting an uphill battle to get X-Ray traces out of your AWS applications.
To make this easier, yarxyarx implements several "hooks" that are transparently added to your code using [wrapknish](https://github.com/guardicore/wrapknish). wrapknish generates wrapper packages with an identical API to the original, and allows you to swap out specific implementations as needed. In our case, we hook several things:
- `net/http`'s HTTP client type and functions
- `golang.org/x/net/context/ctxhttp`'s context-ful functions
- `github.com/aws/aws-lambda-go/lambda`'s Lambda handler initialization (in order to store the context transparently)
- `github.com/aws/aws-sdk-go/aws/session`'s session initialization (in order to wrap newly created service clients with X-Ray)
- the APIs of each service client under `github.com/aws/aws-sdk-go/service/`

For service client APIs, like `s3`'s `ListBuckets()`, there are a lot of overrides we need to make. For each API, we need to make both the `WithContext()` version (i.e., `s3.ListBucketsWithContext()`) and the context-less version (`s3.ListBuckets()`) see the X-Ray segment context. The overrides themselves are generated by the `generate_api_context_go.py` script; the created hooks are fed into wrapknish to create the final package. When this is done, you can just replace your AWS service import paths like this:
```go
import "github.com/aws/aws-sdk-go/service/s3"
```
becomes
```go
import "xray_github.com/aws/aws-sdk-go/service/s3"
```

and X-Ray will trace your S3 actions without needing to make any other changes.

## Requirements
Obviously, you'll need the AWS SDK for Go:
```sh
go get github.com/aws/aws-sdk-go
```

yarxyarx runs [wrapknish](https://github.com/guardicore/wrapknish) in order to create the hooked APIs. You need to have wrapknish installed somewhere in your $PATH.

To compile the wrapped code, you will also need the X-Ray SDK for Go:
```sh
go get github.com/aws/aws-xray-sdk-go
```

## Usage
```sh
git clone https://github.com/guardicore/yarxyarx.git
cd yarxyarx
./generate_xray_hooks
```
The generated hooked packages will be under `./generated_pkgs`. Import these instead of the regular HTTP/AWS SDK packages and you're good to go.

